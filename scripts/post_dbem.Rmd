---
title: "pred_dbem"
author: "Sarah Roberts & Juliano Palacios Abrantes"
date: "2023-10-24"
output: html_document
---

```{r setup, include = F}
source(here::here('./functions/function_list.R')) #I took these from mpa_c_toe

load_pkg(c(
  # For grid estimation and species selection
  "spatialEco","tidyverse", "geosphere","raster","units","matrixStats","sf","rmapshaper", "igraph",
  # For collaborative ease
  "here",
  "readr",
  "janitor"
  ))

# For grid e
# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select

```

# Average ESM data (NO RUN)

```{r average_esm, eval = F, echo = F}

# Scenario grids
scen_grid <- 
  bind_rows(
  read.csv("../data/mpa_scenarios/scenario1.csv") %>% mutate(scen = "S1"),
  read.csv("../data/mpa_scenarios/scenario2.csv") %>%  mutate(scen = "S2"),
  read.csv("../data/mpa_scenarios/scenario3.csv") %>% mutate(scen = "S3")
  ) %>% 
  select(index = Seq, scen, Lat,Lon,prop,status) %>% 
  clean_names()# %>% 
  # For now until we fix the IDs


# Get model list
model_list <- c(
  "C6GFDL85F1MPAS1","C6GFDL85F1MPAS2","C6GFDL85F1MPAS3", # GFDL 85
  "C6GFDL26F1MPAS1","C6GFDL26F1MPAS2","C6GFDL26F1MPAS3", # GFDL 26
  "C6IPSL85F1MPAS1","C6IPSL85F1MPAS2","C6IPSL85F1MPAS3", # IPSL 85
  "C6IPSL26F1MPAS1","C6IPSL26F1MPAS2","C6IPSL26F1MPAS3", # IPSL 26
  "C6MPIS85F1MPAS1",
  "C6MPIS85F1MPAS2",
  "C6MPIS85F1MPAS3", # MPIS 85
  "C6MPIS26F1MPAS1",
  "C6MPIS26F1MPAS2",
  "C6MPIS26F1MPAS3", # MPIS 26
  NULL
  ) 

# Catch (average by ESMs)

lapply(c("Catch","Abd"), agg_dbem_runs, 
       model_list = model_list,
       grid = scen_grid
       )

```


# Load data

```{r}

# Scenario sf
ammb_sf <- st_read(MyFunctions::my_path("D","spatial/ammb","AMM_Bicentenario_CostaRica.shp")) %>% 
  st_transform(4326)

st_crs(ammb_sf) <-4326

coco_sf <- st_read(MyFunctions::my_path("D","spatial/coco","PN_IslaCoco_CostaRica.shp")) %>% 
  st_transform(4326)
st_crs(coco_sf) <-4326

# Scenario grids
scen_grid <- 
  bind_rows(
  read.csv("../data/mpa_scenarios/scenario1.csv") %>% mutate(scen = "S1"),
  read.csv("../data/mpa_scenarios/scenario2.csv") %>%  mutate(scen = "S2"),
  read.csv("../data/mpa_scenarios/scenario3.csv") %>% mutate(scen = "S3")
  ) %>% 
  select(index = Seq, scen, Lat,Lon,prop,status) %>% 
  clean_names()# %>% 
  # For now until we fix the IDs
  # mutate(status = ifelse(status != "protected","unprotected",status))


# Test labels

# ggplot(scen_grid) +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = status
#     )
#   ) +
#   facet_wrap(~scen) +
#   geom_sf(data = ammb_sf %>% mutate(layer = "ammb"), aes(color = layer), fill = "transparent") +
#   geom_sf(data = coco_sf %>% mutate(layer = "cocos"), aes(color = layer), fill = "transparent") +
#   scale_color_viridis_d()

dbem_runs <- bind_rows(
  read_csv("../data/dbem_runs_abd.csv"),
  read_csv("../data/dbem_runs_catch.csv")
)

head(dbem_runs)


```


## Check runs

```{r}
dbem_runs_c %>% 
  group_by(scen,ssp,variable) %>% 
  summarise(total_value = sum(mean_value, na.rm = T),
            mean_value = mean(mean_value, na.rm = T),
            n_species = length(unique(taxon_key))
            )
            
```



# Preeliminary results

## numbers exploration

There is definitely something wrong with the runs 

- Scen 1 has no abundance on surrounding grids and no catch on surrounding 
- Scen 2 has no abundance on oppen grids and no catch data on oppen nor protected
- Scen 3 is the only one working

```{r}

dbem_runs %>% 
  group_by(scen,ssp,variable,status) %>% 
  summarise(total_value = sum(mean_value, na.rm = T),
            mean_value = mean(mean_value, na.rm = T)
            ) %>% 
  View()
```


## Map results

```{r}

dbem_runs %>% 
  group_by(index,year,variable,scen,ssp,lat,lon) %>% 
  summarise(
    total_value = sum(mean_value,na.rm = T)
  ) %>% 
  filter(year %in% c(1951, 1980, 2040),
         lat > 1,
         lat < 8,
         lon < - 83) %>% 
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = total_value,
      color = total_value
    )
  ) +
  scale_fill_viridis_b() +
  scale_color_viridis_b() +
  facet_grid(ssp+year~scen+variable) +
  geom_sf(data = ammb_sf, aes(), fill = "transparent", color = "red", size = 2) +
  geom_sf(data = coco_sf, aes(), fill = "transparent", color = "black", size = 2) +
  theme(legend.position = "bottom")

ggsave(filename = "../results/abd_catch_scen.png",plot = last_plot(),
       height = 10,
       width = 10)

```

## Linear trend by year

```{r}

dbem_runs %>% 
  group_by(year,scen,status,ssp,variable) %>% 
  summarise(
    total_value = sum(mean_value,na.rm = T)
  ) %>% 
  # filter(scen == "S1") %>% 
  ggplot() +
  geom_line(
    aes(
      x = as.numeric(year),
      y = total_value,
      color = scen
    )
  ) +
  facet_wrap(ssp+variable~status,
             scales = "free")
  
ggsave(filename = "../results/abd_catch_scen_lin.png", plot = last_plot(),
       width = 14,
       height = 10)

```

## Linear trend by year (weighted)

This is weighted method of abundance by grid type/number of grids

```{r}

# Estimate ammount of grids
n_status <- scen_grid %>% 
  group_by(status,scen) %>% 
  tally()

# Show result
dbem_runs %>% 
  group_by(index,year,ssp,scen,status,variable) %>% 
  summarise(
    total_value = sum(mean_value,na.rm = T)
  ) %>% 
  group_by(year,status,ssp,scen,variable) %>% 
  summarise(
    total_value = sum(total_value,na.rm = T)
  ) %>% 
  left_join(n_status,
            by = c("status","scen")
            ) %>% 
  mutate(value_wgt = total_value/n) %>% 
  # Testing
  # filter(variable =="Catch") %>%
  # View()
  ggplot() +
  geom_line(
    aes(
      x = as.numeric(year),
      y = value_wgt,
      color = scen
    )
  ) +
  facet_wrap(ssp+status~variable,
             scales = "free")
  

ggsave(filename = "../results/abd_catch_scen_lin_weight.png", plot = last_plot(),
       width = 14,
       height = 10)


```

# Per change


```{r}

dbem_runs %>% 
  group_by(index,year,variable,ssp,scen,lat,lon) %>% 
  summarise(
    total_value = sum(mean_value,na.rm = T),
    .groups = "drop"
  ) %>% 
  mutate(
    period = ifelse(year %in% seq(1995,2014,1),"history",
                    ifelse(year %in% seq(2030,2049,1),"mid",NA))
  ) %>% 
  filter(!is.na(period)) %>% 
  group_by(index,variable,scen,ssp,lat,lon,period) %>% 
  summarise(
    mean_variable = mean(total_value, na.rm = T),
    .groups = "drop"
  ) %>% 
  group_by(index,variable,scen,ssp,lat,lon) %>% 
  mutate(ratio = (lag(mean_variable)-mean_variable)/mean_variable) %>%
  # mutate(ratio = mean_variable/lag(mean_variable)) %>% 
  filter(!is.na(ratio)) %>% 
  ggplot() +
  geom_tile(
  # metR::geom_contour_fill(
    aes(
      x = lon,
      y = lat,
      # z = ratio,
      fill = ratio
    )#,
    # bins = 5
  ) +
  facet_grid(ssp+variable ~ scen) +
  scale_fill_gradient2() +
  MyFunctions::my_land_map() +
  geom_sf(data = ammb_sf, aes(), fill = "transparent") +
  coord_sf(
    xlim = c(-93,-83),
    ylim = c(0,10)
  )
  
        
  ggsave(filename = "../results/per_change.png",plot = last_plot())
  
  
```

