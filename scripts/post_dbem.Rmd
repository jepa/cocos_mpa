---
title: "pred_dbem"
author: "Sarah Roberts & Juliano Palacios Abrantes"
date: "2023-10-24"
output: html_document
---

```{r setup, include = F}

source(here::here('./functions/function_list.R')) #I took these from mpa_c_toe
source(here::here('./functions/figures_fx.R')) #Functions for creating figures

load_pkg(c(
  # For grid estimation and species selection
  "spatialEco","tidyverse", "geosphere","raster","units","matrixStats","sf","rmapshaper", "igraph",
  # For collaborative ease
  "here",
  "readr",
  "janitor"
  ))

# For grid e
# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select


if(Sys.info()[8] == "jepa88"){
data_path <- "~/Library/CloudStorage/OneDrive-UBC/Data/cocos_mpa/"
}else{
  data_path <- "SARAH PLACE YOUR ROOT PATH HERE"
}


# Global color pallets standardization

# Status pallet
status_pallet <- c("#00A08A", # Open
                   "#046C9A", # Protected
                   "#F98400" # Surrounding
                   ) 

# SSP pallet
ssp_pallet <- c("#5BBCD6", #126
                "#FF0000" #585x
                )

# Scenario pallet
scenario_pallet <- c("#02401B", # S1
                     "#FD6467", # S2
                     "#B6854D" # S3
                     )

```


# Double check all species are there (DO not RUN)

```{r double_check, eval = F, echp = F}
# List of folders
folders <- list.files(paste0(data_path,"/data/dbem")


# Check for differences among all pairs of folders
for (i in 1:(length(folders) - 1)) {
  for (j in (i + 1):length(folders)) {
    differing_files <- compare_folders(folders[i], folders[j])
    
    if (length(differing_files) > 0) {
      cat("Files different between", folders[i], "and", folders[j], ":", differing_files, "\n")
    } 
  }
}

# All good!

```


# Average ESM data (DO NOT RUN)

```{r average_esm, eval = F, echo = F}

# Scenario grids
scen_grid <- 
  bind_rows(
  read.csv("../data/mpa_scenarios/scenario1.csv") %>% mutate(scen = "S1"),
  read.csv("../data/mpa_scenarios/scenario2.csv") %>%  mutate(scen = "S2"),
  read.csv("../data/mpa_scenarios/scenario3.csv") %>% mutate(scen = "S3")
  ) %>% 
  select(index = Seq, scen, Lat,Lon,prop,status) %>% 
  clean_names()# %>% 
  # For now until we fix the IDs


# Get model list
model_list <- c(
  "C6GFDL85F1MPAS1","C6GFDL85F1MPAS2","C6GFDL85F1MPAS3", # GFDL 85
  "C6GFDL26F1MPAS1","C6GFDL26F1MPAS2","C6GFDL26F1MPAS3", # GFDL 26
  "C6IPSL85F1MPAS1","C6IPSL85F1MPAS2","C6IPSL85F1MPAS3", # IPSL 85
  "C6IPSL26F1MPAS1","C6IPSL26F1MPAS2","C6IPSL26F1MPAS3", # IPSL 26
  "C6MPIS85F1MPAS1",
  "C6MPIS85F1MPAS2",
  "C6MPIS85F1MPAS3", # MPIS 85
  "C6MPIS26F1MPAS1",
  "C6MPIS26F1MPAS2",
  "C6MPIS26F1MPAS3", # MPIS 26
  NULL
  ) 

# Catch (average by ESMs)

lapply(c("Catch","Abd"), agg_dbem_runs, 
       model_list = model_list,
       grid = scen_grid,
       path = paste0(data_path,"/dbem/results/")
       )

```


## Determine study area

200km ~2 degrees 



```{r study_area, eval = F}

# Latitude in radians
latitude_radians <- 10 * pi / 180

# Longitude conversion factor
conversion_factor <- 111 * cos(latitude_radians)

# Change in Longitude
change_in_longitude <- 200 / conversion_factor

change_in_longitude # about 1.9 degeres rounded at 2



scen_grid %>% 
  # filter(lat <= 8.25,
  #        lat >= 0,
  #        lon >= -91.5,
  #        lon <= -84
  #        ) %>% 
  filter(scen == "S1") %>% 
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = lon
    )
  ) +
  geom_sf(data = ammb_sf, aes(), fill = "transparent", color = "red", size = 2) +
  MyFunctions::my_land_map() +
  coord_sf(
      xlim = c(-93,-83),
      ylim = c(0,10)
    )
  
```

# Load data

```{r}

# Scenario sf
ammb_sf <- st_read(paste0(data_path,"data/spatial/ammb/AMM_Bicentenario_CostaRica.shp")) %>% 
  st_transform(4326)

st_crs(ammb_sf) <-4326

coco_sf <- st_read(paste0(data_path,"data/spatial/coco/PN_IslaCoco_CostaRica.shp")) %>% 
  st_transform(4326)
st_crs(coco_sf) <-4326

# Scenario grids
scen_grid <- 
  bind_rows(
  read.csv("../data/mpa_scenarios/scenario1.csv") %>% mutate(scen = "S1"),
  read.csv("../data/mpa_scenarios/scenario2.csv") %>%  mutate(scen = "S2"),
  read.csv("../data/mpa_scenarios/scenario3.csv") %>% mutate(scen = "S3")
  ) %>% 
  select(index = Seq, scen, Lat,Lon,prop,status) %>% 
  clean_names() %>% 
  filter(lat <= 8.25,
         lat >= 0,
         lon >= -91.5,
         lon <= -84
         )
  # For now until we fix the IDs
  # mutate(status = ifelse(status != "protected","unprotected",status))


# Species list
spp_list <-  readr::read_csv("../data/species/project_species_list.csv") %>% 
  filter(!taxon_key %in% c(600218)) %>%  # remove taxa
  slice(1)



# Test labels

# ggplot(scen_grid) +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = status
#     )
#   ) +
#   facet_wrap(~scen) +
#   geom_sf(data = ammb_sf %>% mutate(layer = "ammb"), aes(color = layer), fill = "transparent") +
#   geom_sf(data = coco_sf %>% mutate(layer = "cocos"), aes(color = layer), fill = "transparent") +
#   scale_color_viridis_d()

dbem_runs <- bind_rows(
  read_csv(paste0(data_path,"/results/dbem_runs_abd.csv")),
  read_csv(paste0(data_path,"/results/dbem_runs_catch.csv"))
) %>% 
  filter(index %in% scen_grid$index)

head(dbem_runs)


```


## Check runs

```{r}
dbem_runs %>% 
  group_by(scen,ssp,variable) %>% 
  summarise(total_value = sum(mean_value, na.rm = T),
            mean_value = mean(mean_value, na.rm = T),
            n_species = length(unique(taxon_key))
            )
            
```

## Map of absolute results

This map will not be included in the report, it is just for reference

```{r}

dbem_runs %>% 
  group_by(index,year,variable,scen,ssp,lat,lon) %>% 
  summarise(
    total_value = sum(mean_value,na.rm = T)
  ) %>% 
  filter(year %in% c(1951, 1980, 2040),
         lat > 1,
         lat < 8,
         lon < - 83) %>% 
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = total_value,
      color = total_value
    )
  ) +
  scale_fill_viridis_b() +
  scale_color_viridis_b() +
  facet_grid(ssp+year~scen+variable) +
  geom_sf(data = ammb_sf, aes(), fill = "transparent", color = "red", size = 2) +
  geom_sf(data = coco_sf, aes(), fill = "transparent", color = "black", size = 2) +
  theme(legend.position = "bottom")

ggsave(filename = "../results/abd_catch_scen.png",plot = last_plot(),
       height = 10,
       width = 10)

```


# Results Aggregated for all species

## numbers exploration

There is definitely something wrong with the runs 

- Scen 1 has no abundance on surrounding grids and no catch on surrounding 
- Scen 2 has no abundance on oppen grids and no catch data on oppen nor protected
- Scen 3 is the only one working

```{r}

dbem_runs %>% 
  group_by(scen,ssp,variable,status) %>% 
  summarise(total_value = sum(mean_value, na.rm = T),
            mean_value = mean(mean_value, na.rm = T)
            ) %>% 
  View()
```


## Linear trend by year

```{r}

trend_scen_fig(data = dbem_runs, data_path = data_path)

```

## Linear trend by year (weighted)

This is weighted method of abundance by grid type/number of grids

```{r}

# Estimate ammount of grids
n_status <- scen_grid %>% 
  group_by(status,scen) %>% 
  tally()

# Show result
dbem_runs %>% 
  group_by(index,year,ssp,scen,status,variable) %>% 
  summarise(
    total_value = sum(mean_value,na.rm = T)
  ) %>% 
  group_by(year,status,ssp,scen,variable) %>% 
  summarise(
    total_value = sum(total_value,na.rm = T)
  ) %>% 
  left_join(n_status,
            by = c("status","scen")
            ) %>% 
  mutate(value_wgt = total_value/n) %>% 
  # Testing
  # filter(variable =="Catch") %>%
  # View()
  ggplot() +
  geom_line(
    aes(
      x = as.numeric(year),
      y = value_wgt,
      color = scen
    )
  ) +
  facet_wrap(ssp+status~variable,
             scales = "free") +
  scale_color_manual("Scenario", values = scenario_pallet) +
  ggtheme_p(leg_pos = "right")
  

ggsave(filename = "../results/figures/abd_catch_scen_lin_weight.png", plot = last_plot(),
       width = 14,
       height = 10)


```

## Delta map


```{r}

map_scen_delta(data = dbem_runs, data_path = data_path)
  
```

# Results per speices

## Line trands of percentage change per scenario

There are a few species such as Black skipjack and Longfin mako that do not havae a distinction between scenarios. This is mostly because the distribution of these species falls quite far from the MPA and thus, the effects of the polygons do not affect their distributions (see maps below).

```{r}

lapply(spp_list$taxon_key, trend_scen_fig, data = dbem_runs, data_path = data_path)

```

## Line trands of percentage change per status

```{r}

lapply(spp_list$taxon_key, trend_status_fig, data = dbem_runs, data_path = data_path)

```
## Delta map

```{r}
lapply(spp_list$taxon_key, map_scen_delta, data = dbem_runs, data_path = data_path)

```
## Delta box plots

```{r}

lapply(spp_list$taxon_key, box_delta_status, data = dbem_runs, data_path = data_path)

```